import React, { useState } from 'react';
import {
  getChannelIdFromUrl,
  getChannelInfo,
  getVideoList,
  getVideoStats,
  calculateEngagementRate,
  calculateViewStability,
  calculateUploadFrequency,
  calculateVibeIndex
} from './YoutubeVibeIndex';

export default function App() {
  const [url, setUrl] = useState('');
  const [channels, setChannels] = useState([]);

  const handleAddChannel = async () => {
    const channelId = await getChannelIdFromUrl(url);
    if (!channelId) return alert('올바른 유튜브 채널 URL을 입력해주세요');

    const info = await getChannelInfo(channelId);
    const videosMeta = await getVideoList(channelId);
    const videoIds = videosMeta.map(v => v.id.videoId);
    const stats = await getVideoStats(videoIds);

    const combined = stats.map((s, i) => ({ ...s, snippet: videosMeta[i].snippet }));
    const E = calculateEngagementRate(combined);
    const V = calculateViewStability(combined);
    const U = calculateUploadFrequency(combined);
    const VIBE = calculateVibeIndex(E, V, U);

    setChannels(prev => [...prev, {
      id: channelId,
      title: info.snippet.title,
      thumbnail: info.snippet.thumbnails.default.url,
      subs: info.statistics.subscriberCount,
      E, V, U, VIBE
    }]);
    setUrl('');
  };

  return (
    <div className="min-h-screen bg-gray-900 text-white p-10">
      <h1 className="text-3xl font-bold mb-6">YouTube VIBE Index 비교기</h1>

      <div className="flex gap-4 mb-8">
        <input
          className="flex-1 p-2 bg-gray-800 border border-gray-600 rounded"
          placeholder="유튜브 채널 URL 입력"
          value={url}
          onChange={e => setUrl(e.target.value)}
        />
        <button
          className="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded"
          onClick={handleAddChannel}
          disabled={channels.length >= 3}
        >채널 추가</button>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        {channels.map((c, idx) => (
          <div key={idx} className="bg-gray-800 p-4 rounded shadow">
            <div className="flex items-center gap-4 mb-4">
              <img src={c.thumbnail} alt={c.title} className="w-12 h-12 rounded-full" />
              <div>
                <h2 className="text-lg font-semibold">{c.title}</h2>
                <p className="text-sm text-gray-400">구독자: {Number(c.subs).toLocaleString()}</p>
              </div>
            </div>
            <div className="space-y-1 text-sm">
              <p>참여율 (E): {c.E.toFixed(2)}%</p>
              <p>조회수 안정성 (V): {(c.V * 100).toFixed(2)}%</p>
              <p>업로드 빈도 (U): {c.U.toFixed(2)}%</p>
              <p className="font-bold text-blue-400">VIBE Index: {c.VIBE.toFixed(2)}</p>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
